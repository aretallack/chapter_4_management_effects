---
title: "contextual maps"
format: html
editor_options: 
  chunk_output_type: console
---
```{r}
pacman::p_load(tidyverse, plyr, tidyterra, sf, terra, mblm, ggpubr)

raster <- rast(list.files("./outputs/raster/guerschman_fc_monthly", "*.nc$", full.names = T))
study_area <- read_sf("./outputs/vector/bonbon_buffer.gpkg") %>% 
  st_geometry()

agcd_rain <- rast("./outputs/raster/agcd_precipitation/agcd_v2-0-1_precip_total_r001_monthly_2000_2022.nc") %>% 
  .[[time(.) > ymd("2000-01-01")]]

summer_months <- which(month(time(agcd_rain)) %in% c(12, 1, 2))
winter_months <- which(month(time(agcd_rain)) %in% c(6, 7, 8))

summer_rain <- agcd_rain[[summer_months]] %>% 
  mean() %>% 
  mask(vect(study_area))

winter_rain <- agcd_rain[[winter_months]] %>% 
  mean() %>% 
  mask(vect(study_area))

# tmax <- rast("E:/data/climate_data/temperature/agcd_tmax_monthly_1971_2022.nc") %>% 
#   .[[time(.) > ymd("2000-01-01")]] %>% 
#   project(summer_rain) %>%
#   mean() %>%
#   mask(vect(study_area))


ibra_sr <- read_sf("./data/vector/ibra_subregions.gpkg") %>% 
  st_intersection(st_geometry(study_area)[1]) %>% 
  select(SUB_NAME_7) %>% 
  filter(SUB_NAME_7 != "Gawler Lakes") %>% 
  rasterize(summer_rain, field = "SUB_NAME_7")
 

nvis <- rast("E:/data/Basedata/Environmental/NVIS/FGDB_NVIS6_0_AUST_EXT_MVG/NVIS6_0_AUST_EXT_MVG_ALB.tif") %>% 
  project(tmax)
nvis <- droplevels(nvis)
nvis[nvis %in% c(6, 13, 16)] <- 13
nvis[!nvis %in% c(22, 13)] <-  NA
nvis <- droplevels(nvis)

level_names <- levels(nvis)[[1]]
level_names[,2] <- c("Acacia Open Woodlands", "Chenopod Shrublands")

levels(nvis) <- level_names

nvis <- nvis %>% 
  mask(vect(study_area))
```


# Plot

```{r}
plot_rasters <- function(raster, title) {
  ggplot() +
    geom_spatraster(data = raster, na.rm = T) +
    geom_sf(data = st_buffer(study_area[1], 500), fill = "transparent", linewidth = 1.5) +
    geom_sf(data = study_area, fill = "transparent", linewidth = 1.5, colour = c("#FFFF73", "#73B2FF")) +
    labs(title = title,
         fill = title) +
    theme_classic() +
    theme(legend.position = "bottom",
          legend.margin = margin(-0.8,-0.8,-0.8,-0.8, "cm"),
          legend.title = element_blank(),
          legend.key = element_rect(colour = "black"),
          legend.text = element_text(size = unit(8, "cm")),
          axis.text = element_blank(),
          axis.line = element_blank(),
          axis.ticks = element_blank(),
          plot.title = element_text(size = unit(10, "cm"),
                                    face = "bold",
                                    hjust = 0.5,
                                    vjust = -2),
          plot.margin = margin(0,0,1,0, "cm")
    )
  }

summer_rain_plot <- plot_rasters(summer_rain, "Mean Summer Monthly\nRainfall (mm)") +
  scale_fill_viridis_c(
    option = "viridis",
    direction = -1,
    na.value = NA,
    limits = c(round_any(minmax(summer_rain)[1], -1), 
               round_any(minmax(summer_rain)[2], 1) + 0.1),
    breaks = seq(round_any(minmax(summer_rain)[1], -1), 
                 round_any(minmax(summer_rain)[2], 1),
                 1),
    guide = guide_colorbar(frame.colour = "black",
                           ticks.colour = "black")
    )
winter_rain_plot <- plot_rasters(winter_rain, "Mean Winter Monthly\nRainfall (mm)") +
  scale_fill_viridis_c(
    option = "viridis",
    direction = -1,
    na.value = NA,
    limits = c(round_any(minmax(winter_rain)[1], -1) - 0.1,
                 round_any(minmax(winter_rain)[2], 1) + 0.1),
    breaks = seq(round_any(minmax(winter_rain)[1], -1),
                 round_any(minmax(winter_rain)[2], 1)),
    guide = guide_colorbar(frame.colour = "black",
                           ticks.colour = "black")
    )
tmax_plot <- plot_rasters(tmax, "Mean Maximum Daily\nTemperature (Â°C)") +
  scale_fill_viridis_c(
    option = "plasma",
    direction = 1,
    na.value = NA,
    limits = c(plyr::round_any(minmax(tmax)[1], -0.1),
                 plyr::round_any(minmax(tmax)[2], -0.1)),
    breaks = seq(plyr::round_any(minmax(tmax)[1], -0.1),
                 plyr::round_any(minmax(tmax)[2], -0.1),
                 0.2) ,
    guide = guide_colorbar(frame.colour = "black",
                           ticks.colour = "black")
    )

ibra_plot <- plot_rasters(ibra_sr, "IBRA Subregions") +  
  theme(legend.direction = "vertical",
        legend.position = c(0.5, 0),
        plot.margin = margin(0,0,0.85,0, "cm"),
        legend.key = element_rect(colour = "black"),
        legend.key.height = unit(0.3, "cm")) +
  scale_fill_manual(values = RColorBrewer::brewer.pal(8, "Set2")[1:3],
                    na.translate = FALSE)

nvis_plot <- plot_rasters(nvis, "Vegetation Groups\n(NVIS)") +
  theme(legend.direction = "vertical",
        legend.position = c(0.5, 0),
        plot.margin = margin(0,0,0.85,0, "cm"),
        legend.key = element_rect(colour = "black"),
        legend.key.height = unit(0.3, "cm")) +
  scale_fill_manual(values = c("steelblue", "pink"),
                    labels = c("Acacia Open Woodland", "Chenopod Shrubland"),
                    na.translate = FALSE)

ggpubr::ggarrange(summer_rain_plot,
                  winter_rain_plot,
                  ibra_plot,
                  nvis_plot,
                  ncol = 4)

ggsave("./figures/context_maps.png",
       width = 16,
       height = 8,
       units = "cm")
```


