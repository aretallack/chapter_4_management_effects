---
title: "Locations of greatest difference, before vs after"
format: html
editor_options: 
  chunk_output_type: console
---

```{r}
stations <- sf::read_sf("./outputs/vector/pastoral_stations.gpkg") %>% 
  st_geometry()
  # rasterize(rasters[[1]], field = "NAME")

rasters <- rast("./outputs/raster/guerschman_fc_monthly/fc_monthly_pv_20010101_20230101.nc")
before <- rasters[[time(rasters) < as_date("2006-01-01")]]
after <- rasters[[time(rasters) > as_date("2012-12-01")]]
after <- after[[time(after) < as_date("2017-01-01")]]



before_mean <- mean(before)
after_mean <- mean(after)
mean_difference <- after_mean - before_mean
rolling_difference <- rasters - before_mean

rolling_difference %>% 
  terra::zonal(stations) %>% 
  as_tibble() %>%
  set_names(c("station", as.character(time(rasters)))) %>% 
  pivot_longer(-1) %>% 
  filter(station %in% c("Bon Bon", "Coondambo", "Mount Eba", "Mount Vivian", "North Well")) %>% 
  ggplot(aes(x = as_date(name), y = value, colour = station)) +
  geom_line() +
  geom_smooth(method = lm, se = F)

test1 <- app(rolling_difference, sd)


plot(mean_difference) + plot(stations, add = T)


before_median <- median(before)
after_median <- median(after)
median_difference <- after_median - before_median

```

