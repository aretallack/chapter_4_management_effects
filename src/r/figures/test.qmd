---
title: "Plot effects"
format: html
editor_options: 
  chunk_output_type: inline
---

```{r}
dat <- read_parquet("./outputs/tables/bonbon.parquet") %>% 
  mutate(bonbon = as.factor(ifelse(station == "Bon Bon", 1, 0)))

library(dtplyr)
as.data.table(dat) %>%
  lazy_dt() %>% 
  arrange(date) %>%
  group_by(station) %>% 
  summarise(pv05_12mo = frollapply(pv, 12, FUN = \(x) quantile(x, 0.05)),
            npv05_12mo = frollapply(npv, 12, FUN = \(x) quantile(x, 0.05)),
            bare95_12mo = frollapply(bare, 12, FUN = \(x) quantile(x, 0.95))) %>% 
  show_query()


test <- dat[order(date)][, .(pv05_12mo = frollapply(pv, 12, FUN = function(x) quantile(x, 0.05)), 
    npv05_12mo = frollapply(npv, 12, FUN = function(x) quantile(x, 0.05)), 
    bare95_12mo = frollapply(bare, 12, FUN = function(x) quantile(x, 0.95)),
    bonbon = unique(bonbon),
    date = unique(date)), keyby = .(cell)]

test2 <- test %>%
  group_by(bonbon, date) %>% 
  summarise(pv05_12mo = mean(pv05_12mo, na.rm = T),
            npv05_12mo = mean(npv05_12mo, na.rm = T),
            bare95_12mo = mean(bare95_12mo, na.rm = T))

```

