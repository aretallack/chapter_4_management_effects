---
title: "Spatial GAMS"
author: "Angus Retallack"
date: "2022-08-31"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, lubridate, terra, sf, fields, arrow, data.table)

outputFolder <- "./RasterVariables"
```

# Create / Load Variables

## Vegetation variables
### TVC
```{r}
baseTVC <- "E:/Data/MODIS/GuerschmanFC/Monthly/Processed/"

pathTVC <- file.path(baseTVC, "TVC")

filesTVC <- list.files(pathTVC, "*.tif$", full.names = TRUE)
TVC <- rast(filesTVC)

# add dates
dates <- names(TVC) %>%
  substr(., 18, 24) %>% 
  str_replace("\\.", "-") %>% 
  paste0(., "-01") %>% 
  as_date()

# Add times (dates) to TVC stack
time(TVC) <- dates

firstDate <- time(TVC)[1]
lastDate <- time(TVC)[length(time(TVC))]
```

#### Template Raster

Blank raster generated from TVC, used as a template for creating additional
rasters for modelling

```{r}
blankRast <- TVC[[1]]
blankRast[!is.na(blankRast)] <- NA
names(blankRast) <- "blankRast"
```

### PV

```{r}
basePV <- "E:/Data/MODIS/GuerschmanFC/Monthly/Processed"

filesPV <- list.files(basePV, "*.tif$", full.names = TRUE) %>% 
  .[which(str_detect(., "_2"))]

PV <- rast(filesPV)

time(PV) <- dates

meanPV <- mean(PV) %>% 
  rep(., dim(PV)[3])
stdPV <- stdev(PV) %>% 
  rep(., dim(PV)[3])
maxPV <- max(PV) %>% 
  rep(., dim(PV)[3])
```

### NPV

```{r}
filesNPV <- list.files(basePV, "*.tif$", full.names = TRUE) %>% 
  .[which(str_detect(., "_3"))]

NPV <- rast(filesNPV)

time(NPV) <- dates
```


## Statistical zones

Load shapefile of statistical zones (Stations and IBRA regions)

```{r}
stations <- read_sf("./Vector/stations.shp")
stationNames <- unique(stations$name)

IBRARegions <- read_sf("./Vector/IBRA.shp")

stationsRaster <- rep(rasterize(vect(stations), blankRast, field = "name"), length(names(TVC)))
subregionsRaster <- rep(rasterize(vect(IBRARegions), blankRast, field = "sub_name_7"), length(names(TVC)))
regionsRaster <- rep(rasterize(vect(IBRARegions), blankRast, field = "reg_name_7"), length(names(TVC)))

extentRaster <- stationsRaster[[1]]
extentRaster[!is.na(extentRaster)] <- 1

#  Rename class to Study Area
levels(extentRaster) <- data.frame(id = 1:length(unlist(levels(extentRaster))),
       class = rep("Study Area", length(unlist(levels(extentRaster)))))

# Land systems
pastoralLandSystems <- read_sf("E:/Data/Basedata/Mapland/Statewide/LANDSCAPE_LandSystemsMapping_GDA2020.shp")
pastoralLandSystems$geometry <- st_transform(pastoralLandSystems$geometry, st_crs(stations$geometry))
pastoralLandSystems$LANDSYSTEM <- as.factor(pastoralLandSystems$LANDSYSTEM)

landSystemsRaster <- rep(rasterize(vect(pastoralLandSystems), blankRast, field = "LANDSYSTEM"), length(names(TVC)))

nvis_s <- rast("E:/Data/NVIS/FGDB_NVIS6_0_AUST_EXT_MVS/NVIS6_0_AUST_EXT_MVS_ALB.tif") %>% 
  project(blankRast)
nvis_s[nvis_s == "Unknown/No data"] <- -999

nvis_s <- rep(nvis_s, length(names(TVC)))

nvis <- rast("E:/Data/NVIS/FGDB_NVIS6_0_AUST_EXT_MVG/NVIS6_0_AUST_EXT_MVG_ALB.tif") %>% 
  project(blankRast)
nvis[nvis == "Unknown/no data"] <- -999

nvis <- rep(nvis, length(names(TVC)))

# waterDesc <- c("creek", "lake", "Lake", "swamp")
# 
# # Add 1 / 0 to additional column where landystem descriptions match keywords above
# # 1's can be filtered out from modelling later.
# pastoralLandSystems <- pastoralLandSystems %>% 
#   mutate(., water = ifelse(str_detect(DESCN1, paste(waterDesc, collapse = "|")), 1, 0), .after = 5)
# 
# waterRaster <- rep(rasterize(vect(pastoralLandSystems), blankRast, field = "water"), length(names(TVC)))
# # writeRaster(waterRaster[[1]], file.path(outputFolder, "waterRaster.tif"), datatype = "INT1U", overwrite = T)
```

## Water Areas
For masking pixels

```{r}
water <- read_sf("E:/Data/Water Courses/HydroPolys.shp") %>% 
  add_column(water = 1)

water$geometry <- st_transform(water$geometry, st_crs(stations$geometry))

waterRaster <- rep(rasterize(vect(water), blankRast, field = "water"), length(names(TVC)))

waterRaster[is.nan(waterRaster)] <- -999
```


## Rainfall

### GPM

```{r}
##################
### Tri-Annual ###
##################

rainfallGPM36 <- rast(list.files("E:/Data/Rainfall/GPM IMERG/Processed/RollingTriAnnual", "*.tif$", full.names = TRUE)) %>% 
  project(blankRast) %>% 
  crop(blankRast)

datesGPM <- names(rainfallGPM36) %>% 
  str_split(., "\\.", simplify = TRUE) %>% 
  .[, 5] %>% 
  str_split(., "-", simplify = TRUE) %>% 
  .[, 1] %>% 
  {paste(str_sub(., 1, 4), str_sub(., 5, 6), str_sub(., 7, 8), sep = "/")} %>% 
  as_date()

time(rainfallGPM36) <- datesGPM
# Add blank rasters to dates missing before and fix those dates. 
missingBefore <- length(seq(from = firstDate, to = time(rainfallGPM36)[1], by = 'month')) - 1
rainfallGPM36 <- c(rep(blankRast, missingBefore), rainfallGPM36)
time(rainfallGPM36)[1:missingBefore] <- seq(firstDate, (firstDate + (30 * (missingBefore - 1))), by = "month")

# Add blank rasters to dates missing after
missingAfter <- length(seq(from = time(rainfallGPM36)[length(time(rainfallGPM36))], to = lastDate, by = 'month')) - 1
rainfallGPM36 <- c(rainfallGPM36, rep(blankRast, missingAfter))
time(rainfallGPM36)[(length(names(rainfallGPM36)) - (missingAfter - 1)):length(names(rainfallGPM36))] <- seq(time(rainfallGPM36)[length(names(rainfallGPM36)) - (missingAfter)] + 30, lastDate, by = "month")

rainfallGPM36[is.na(rainfallGPM36)] <- -999

#################
### Bi-Annual ###
#################

rainfallGPM24 <- rast(list.files("E:/Data/Rainfall/GPM IMERG/Processed/RollingBiAnnual", "*.tif$", full.names = TRUE)) %>% 
  project(blankRast) %>% 
  crop(blankRast)

datesGPM <- names(rainfallGPM24) %>% 
  str_split(., "\\.", simplify = TRUE) %>% 
  .[, 5] %>% 
  str_split(., "-", simplify = TRUE) %>% 
  .[, 1] %>% 
  {paste(str_sub(., 1, 4), str_sub(., 5, 6), str_sub(., 7, 8), sep = "/")} %>% 
  as_date()

time(rainfallGPM24) <- datesGPM
# Add blank rasters to dates missing before and fix those dates. 
missingBefore <- length(seq(from = firstDate, to = time(rainfallGPM24)[1], by = 'month')) - 1
rainfallGPM24 <- c(rep(blankRast, missingBefore), rainfallGPM24)
time(rainfallGPM24)[1:missingBefore] <- seq(firstDate, (firstDate + (30 * (missingBefore - 1))), by = "month")

# Add blank rasters to dates missing after
missingAfter <- length(seq(from = time(rainfallGPM24)[length(time(rainfallGPM24))], to = lastDate, by = 'month')) - 1
rainfallGPM24 <- c(rainfallGPM24, rep(blankRast, missingAfter))
time(rainfallGPM24)[(length(names(rainfallGPM24)) - (missingAfter - 1)):length(names(rainfallGPM24))] <- seq(time(rainfallGPM24)[length(names(rainfallGPM24)) - (missingAfter)] + 30, lastDate, by = "month")

rainfallGPM24[is.na(rainfallGPM24)] <- -999

##############
### Annual ###
##############

rainfallGPMa <- rast(list.files("E:/Data/Rainfall/GPM IMERG/Processed/RollingAnnual", "*.tif$", full.names = TRUE)) %>% 
  project(blankRast) %>% 
  crop(blankRast)

datesGPM <- names(rainfallGPMa) %>% 
  str_split(., "\\.", simplify = TRUE) %>% 
  .[, 5] %>% 
  str_split(., "-", simplify = TRUE) %>% 
  .[, 1] %>% 
  {paste(str_sub(., 1, 4), str_sub(., 5, 6), str_sub(., 7, 8), sep = "/")} %>% 
  as_date()

time(rainfallGPMa) <- datesGPM
# Add blank rasters to dates missing before and fix those dates. 
missingBefore <- length(seq(from = firstDate, to = time(rainfallGPMa)[1], by = 'month')) - 1
rainfallGPMa <- c(rep(blankRast, missingBefore), rainfallGPMa)
time(rainfallGPMa)[1:missingBefore] <- seq(firstDate, (firstDate + (30 * (missingBefore - 1))), by = "month")

# Add blank rasters to dates missing after
missingAfter <- length(seq(from = time(rainfallGPMa)[length(time(rainfallGPMa))], to = lastDate, by = 'month')) - 1
rainfallGPMa <- c(rainfallGPMa, rep(blankRast, missingAfter))
time(rainfallGPMa)[(length(names(rainfallGPMa)) - (missingAfter - 1)):length(names(rainfallGPMa))] <- seq(time(rainfallGPMa)[length(names(rainfallGPMa)) - (missingAfter)] + 30, lastDate, by = "month")

rainfallGPMa[is.na(rainfallGPMa)] <- -999

#################
### Quarterly ###
#################

rainfallGPMq <- rast(list.files("E:/Data/Rainfall/GPM IMERG/Processed/RollingQuarterly", "*.tif$", full.names = TRUE)) %>% 
  project(blankRast) %>% 
  crop(blankRast)

datesGPM <- names(rainfallGPMq) %>% 
  str_split(., "\\.", simplify = TRUE) %>% 
  .[, 5] %>% 
  str_split(., "-", simplify = TRUE) %>% 
  .[, 1] %>% 
  {paste(str_sub(., 1, 4), str_sub(., 5, 6), str_sub(., 7, 8), sep = "/")} %>% 
  as_date()

time(rainfallGPMq) <- datesGPM

# Remove dates before first TVC date
rainfallGPMq <- rainfallGPMq[[-c(1:which(time(rainfallGPMq) == firstDate) - 1)]] 

# Add blank rasters to dates missing after
missingAfter <- length(seq(from = time(rainfallGPMq)[length(time(rainfallGPMq))], to = lastDate, by = 'month')) - 1
rainfallGPMq <- c(rainfallGPMq, rep(blankRast, missingAfter))
time(rainfallGPMq)[(length(names(rainfallGPMq)) - (missingAfter - 1)):length(names(rainfallGPMq))] <- seq(time(rainfallGPMq)[length(names(rainfallGPMq)) - (missingAfter)] + 30, lastDate, by = "month")

rainfallGPMq[is.na(rainfallGPMq)] <- -999

###############
### Monthly ###
###############

rainfallGPMm <- rast(list.files("E:/Data/Rainfall/GPM IMERG/Processed", "*.tif$", full.names = TRUE)) %>% 
  project(blankRast) %>% 
  crop(blankRast)

datesGPM <- names(rainfallGPMm) %>% 
  str_split(., "\\.", simplify = TRUE) %>% 
  .[, 5] %>% 
  str_split(., "-", simplify = TRUE) %>% 
  .[, 1] %>% 
  {paste(str_sub(., 1, 4), str_sub(., 5, 6), str_sub(., 7, 8), sep = "/")} %>% 
  as_date()

time(rainfallGPMm) <- datesGPM

# Remove dates before first TVC date
rainfallGPMm <- rainfallGPMm[[-c(1:which(time(rainfallGPMm) == firstDate) - 1)]] 

# Add blank rasters to dates missing after
missingAfter <- length(seq(from = time(rainfallGPMm)[length(time(rainfallGPMm))], to = lastDate, by = 'month')) - 1
rainfallGPMm <- c(rainfallGPMm, rep(blankRast, missingAfter))
time(rainfallGPMm)[(length(names(rainfallGPMm)) - (missingAfter - 1)):length(names(rainfallGPMm))] <- seq(time(rainfallGPMm)[length(names(rainfallGPMm)) - (missingAfter)] + 30, lastDate, by = "month")

rainfallGPMm[is.na(rainfallGPMm)] <- -999
```

### CHIRPS

```{r}
#################
### Bi-Annual ###
#################
rainfallCHIRPS24 <- rast(list.files("E:/Data/Rainfall/CHIRPS/Processed/RollingBiAnnual", "*.tif$", full.names = TRUE)) %>% 
  project(blankRast) %>% 
  crop(blankRast)

datesCHIRPS24 <- names(rainfallCHIRPS24) %>% 
  str_split(., "\\.", simplify = TRUE) %>% 
  .[, 3:4] %>% 
  apply(., 1, function(x) str_flatten(x, collapse = "/")) %>% 
  paste0(., "/01") %>% 
  as_date()

time(rainfallCHIRPS24) <- datesCHIRPS24

## Add blank rasters to dates missing before and fix those dates. 
missingBefore <- length(seq(from = firstDate, to = time(rainfallCHIRPS24)[1], by = 'month')) - 1
rainfallCHIRPS24 <- c(rep(blankRast, missingBefore), rainfallCHIRPS24)
time(rainfallCHIRPS24)[1:missingBefore] <- seq(firstDate, (firstDate + (30 * (missingBefore - 1))), by = "month")

# Add blank rasters to dates missing after
missingAfter <- length(seq(from = time(rainfallCHIRPS24)[length(time(rainfallCHIRPS24))], to = lastDate, by = 'month')) - 1
rainfallCHIRPS24 <- c(rainfallCHIRPS24, rep(blankRast, missingAfter))
time(rainfallCHIRPS24)[(length(names(rainfallCHIRPS24)) - (missingAfter - 1)):length(names(rainfallCHIRPS24))] <- seq(time(rainfallCHIRPS24)[length(names(rainfallCHIRPS24)) - (missingAfter)] + 30, lastDate, by = "month")

rainfallCHIRPS24[is.na(rainfallCHIRPS24)] <- -999

##############
### Annual ###
##############

rainfallCHIRPSa <- rast(list.files("E:/Data/Rainfall/CHIRPS/Processed/RollingAnnual", "*.tif$", full.names = TRUE)) %>% 
  project(blankRast) %>% 
  crop(blankRast)

datesCHIRPSa <- names(rainfallCHIRPSa) %>% 
  str_split(., "\\.", simplify = TRUE) %>% 
  .[, 3:4] %>% 
  apply(., 1, function(x) str_flatten(x, collapse = "/")) %>% 
  paste0(., "/01") %>% 
  as_date()

time(rainfallCHIRPSa) <- datesCHIRPSa
# Remove dates before first TVC date
rainfallCHIRPSa <- rainfallCHIRPSa[[-c(1:which(time(rainfallCHIRPSa) == firstDate) - 1)]] 
# Add blank rasters to dates missing after
missingAfter <- length(seq(from = time(rainfallCHIRPSa)[length(time(rainfallCHIRPSa))], to = lastDate, by = 'month')) - 1
rainfallCHIRPSa <- c(rainfallCHIRPSa, rep(blankRast, missingAfter))
time(rainfallCHIRPSa)[(length(names(rainfallCHIRPSa)) - (missingAfter - 1)):length(names(rainfallCHIRPSa))] <- seq(time(rainfallCHIRPSa)[length(names(rainfallCHIRPSa)) - (missingAfter)] + 30, lastDate, by = "month")

rainfallCHIRPSa[is.na(rainfallCHIRPSa)] <- -999

#################
### Quarterly ###
#################

rainfallCHIRPSq <- rast(list.files("E:/Data/Rainfall/CHIRPS/Processed/RollingQuarterly", "*.tif$", full.names = TRUE)) %>% 
  project(blankRast) %>% 
  crop(blankRast)

datesCHIRPSq <- names(rainfallCHIRPSq) %>% 
  str_split(., "\\.", simplify = TRUE) %>% 
  .[, 3:4] %>% 
  apply(., 1, function(x) str_flatten(x, collapse = "/")) %>% 
  paste0(., "/01") %>% 
  as_date()

time(rainfallCHIRPSq) <- datesCHIRPSq

# Remove dates before first TVC date
rainfallCHIRPSq <- rainfallCHIRPSq[[-c(1:which(time(rainfallCHIRPSq) == firstDate) - 1)]] 

# Add blank rasters to dates missing after
missingAfter <- length(seq(from = time(rainfallCHIRPSq)[length(time(rainfallCHIRPSq))], to = lastDate, by = 'month')) - 1
rainfallCHIRPSq <- c(rainfallCHIRPSq, rep(blankRast, missingAfter))
time(rainfallCHIRPSq)[(length(names(rainfallCHIRPSq)) - (missingAfter - 1)):length(names(rainfallCHIRPSq))] <- seq(time(rainfallCHIRPSa)[length(names(rainfallCHIRPSa)) - (missingAfter)] + 30, lastDate, by = "month")

rainfallCHIRPSq[is.na(rainfallCHIRPSq)] <- -999

###############
### Monthly ###
###############

rainfallCHIRPSm <- rast(list.files("E:/Data/Rainfall/CHIRPS/Processed", "*.tif$", full.names = TRUE)) %>% 
  project(blankRast) %>% 
  crop(blankRast)

datesCHIRPSm <- names(rainfallCHIRPSm) %>% 
  str_split(., "\\.", simplify = TRUE) %>% 
  .[, 3:4] %>% 
  apply(., 1, function(x) str_flatten(x, collapse = "/")) %>% 
  paste0(., "/01") %>% 
  as_date()

time(rainfallCHIRPSm) <- datesCHIRPSm

# Remove dates before first TVC date
rainfallCHIRPSm <- rainfallCHIRPSm[[-c(1:which(time(rainfallCHIRPSm) == firstDate) - 1)]] 
# Add blank rasters to dates missing after
missingAfter <- length(seq(from = time(rainfallCHIRPSm)[length(time(rainfallCHIRPSm))], to = lastDate, by = 'month')) - 1
rainfallCHIRPSm <- c(rainfallCHIRPSm, rep(blankRast, missingAfter))
time(rainfallCHIRPSm)[(length(names(rainfallCHIRPSm)) - (missingAfter - 1)):length(names(rainfallCHIRPSm))] <- seq(time(rainfallCHIRPSa)[length(names(rainfallCHIRPSa)) - (missingAfter)] + 30, lastDate, by = "month")

rainfallCHIRPSm[is.na(rainfallCHIRPSm)] <- -999

```

### AGCD

```{r}
#################
### Bi-Annual ###
#################

rainfallAGCD24 <- rast(list.files("E:/Data/Rainfall/AGCD/Processed/RollingBiAnnual", "*.tif$", full.names = TRUE)) %>% 
  project(blankRast) %>% 
  crop(blankRast)

datesAGCD24 <- names(rainfallAGCD24) %>% 
  str_split(., "_", simplify = TRUE) %>% 
  .[, 7] %>%
  str_remove(., ".tif") %>% 
  str_replace(., "-", "/") %>% 
  paste0(., "/01") %>% 
  as_date()

time(rainfallAGCD24) <- datesAGCD24

## Add blank rasters to dates missing before and fix those dates. 
missingBefore <- length(seq(from = firstDate, to = time(rainfallAGCD24)[1], by = 'month')) - 1
rainfallAGCD24 <- c(rep(blankRast, missingBefore), rainfallAGCD24)
time(rainfallAGCD24)[1:missingBefore] <- seq(firstDate, (firstDate + (30 * (missingBefore - 1))), by = "month")

# Add blank rasters to dates missing after
missingAfter <- length(seq(from = time(rainfallAGCD24)[length(time(rainfallAGCD24))], to = lastDate, by = 'month')) - 1
rainfallAGCD24 <- c(rainfallAGCD24, rep(blankRast, missingAfter))
time(rainfallAGCD24)[(length(names(rainfallAGCD24)) - (missingAfter - 1)):length(names(rainfallAGCD24))] <- seq(time(rainfallAGCD24)[length(names(rainfallAGCD24)) - (missingAfter)] + 30, lastDate, by = "month")

rainfallAGCD24[is.na(rainfallAGCD24)] <- -999

##############
### Annual ###
##############

rainfallAGCDa <- rast(list.files("E:/Data/Rainfall/AGCD/Processed/RollingAnnual", "*.tif$", full.names = TRUE)) %>% 
  project(blankRast) %>% 
  crop(blankRast)

datesAGCDa <- names(rainfallAGCDa) %>% 
  str_split(., "_", simplify = TRUE) %>% 
  .[, 7] %>%
  str_remove(., ".tif") %>% 
  str_replace(., "-", "/") %>% 
  paste0(., "/01") %>% 
  as_date()

time(rainfallAGCDa) <- datesAGCDa

# Remove dates before first TVC date
rainfallAGCDa <- rainfallAGCDa[[-c(1:which(time(rainfallAGCDa) == firstDate) - 1)]] 

# Add blank rasters to dates missing after
missingAfter <- length(seq(from = time(rainfallAGCDa)[length(time(rainfallAGCDa))], to = lastDate, by = 'month')) - 1
rainfallAGCDa <- c(rainfallAGCDa, rep(blankRast, missingAfter))
time(rainfallAGCDa)[(length(names(rainfallAGCDa)) - (missingAfter - 1)):length(names(rainfallAGCDa))] <- seq(time(rainfallAGCDa)[length(names(rainfallAGCDa)) - (missingAfter)] + 30, lastDate, by = "month")

rainfallAGCDa[is.na(rainfallAGCDa)] <- -999

#################
### Quarterly ###
#################

rainfallAGCDq <- rast(list.files("E:/Data/Rainfall/AGCD/Processed/RollingQuarterly", "*.tif$", full.names = TRUE)) %>% 
  project(blankRast) %>% 
  crop(blankRast)

datesAGCDq <- names(rainfallAGCDq) %>% 
  str_split(., "_", simplify = TRUE) %>% 
  .[, 7] %>%
  str_remove(., ".tif") %>% 
  str_replace(., "-", "/") %>% 
  paste0(., "/01") %>% 
  as_date()

time(rainfallAGCDq) <- datesAGCDq

# Remove dates before first TVC date
rainfallAGCDq <- rainfallAGCDq[[-c(1:which(time(rainfallAGCDq) == firstDate) - 1)]] 

# Add blank rasters to dates missing after
missingAfter <- length(seq(from = time(rainfallAGCDq)[length(time(rainfallAGCDq))], to = lastDate, by = 'month')) - 1
rainfallAGCDq <- c(rainfallAGCDq, rep(blankRast, missingAfter))
time(rainfallAGCDq)[(length(names(rainfallAGCDq)) - (missingAfter - 1)):length(names(rainfallAGCDq))] <- seq(time(rainfallAGCDq)[length(names(rainfallAGCDq)) - (missingAfter)] + 30, lastDate, by = "month")

rainfallAGCDq[is.na(rainfallAGCDq)] <- -999

###############
### Monthly ###
###############

rainfallAGCDm <- rast(list.files("E:/Data/Rainfall/AGCD/Processed", "*.tif$", full.names = TRUE)) %>% 
  project(blankRast) %>% 
  crop(blankRast)

datesAGCDm <- names(rainfallAGCDm) %>% 
  str_split(., "_", simplify = TRUE) %>% 
  .[, 7] %>%
  str_remove(., ".tif") %>% 
  str_replace(., "-", "/") %>% 
  paste0(., "/01") %>% 
  as_date()

time(rainfallAGCDm) <- datesAGCDm

# Remove dates before first TVC date
rainfallAGCDm <- rainfallAGCDm[[-c(1:which(time(rainfallAGCDm) == firstDate) - 1)]] 

# Add blank rasters to dates missing after
missingAfter <- length(seq(from = time(rainfallAGCDm)[length(time(rainfallAGCDm))], to = lastDate, by = 'month')) - 1
rainfallAGCDm <- c(rainfallAGCDm, rep(blankRast, missingAfter))
time(rainfallAGCDm)[(length(names(rainfallAGCDm)) - (missingAfter - 1)):length(names(rainfallAGCDm))] <- seq(time(rainfallAGCDm)[length(names(rainfallAGCDm)) - (missingAfter)] + 30, lastDate, by = "month")

rainfallAGCDm[is.na(rainfallAGCDm)] <- -999
```

## Dog Fence

Inside / outside of the dog fence

```{r}
dogFence_shp <- read_sf("E:/Data/DogFence/dogFence_Polygons.shp") %>% 
  st_cast("POLYGON") %>% 
  st_transform("EPSG:28353") %>% 
  as_tibble() %>% 
  .[, -1] %>% 
  mutate(shape_area = as.numeric(st_area(st_make_valid(geometry))), .before = 1) %>% 
  arrange(desc(shape_area)) %>% 
  add_column(inside = 1, .before = 1)


# Set largest polygon to 0
dogFence_shp$inside[1] <- 0


extent <- terra::as.polygons(extentRaster) %>% 
  st_as_sf() %>% 
  st_geometry() %>% 
  st_cast("POLYGON")


dogFence_Extent <- st_intersection(dogFence_shp$geometry, extent) %>% 
  st_cast("MULTIPOLYGON") %>% 
  st_cast("POLYGON") %>% 
  as_tibble() %>% 
  add_column(inside = as.numeric(NA), .before = 1)


for (i in 1:nrow(dogFence_Extent)) {
  dogFence_Index <- as.numeric(na.omit(as.numeric(st_intersects(st_point_on_surface(dogFence_Extent$geometry[i]), dogFence_shp$geometry))))
  dogFence_Extent$inside[i] <- dogFence_shp$inside[dogFence_Index]
}


dogFence <- rasterize(vect(st_sf(dogFence_Extent)), blankRast, "inside")

levels(dogFence) <- c(as.factor("outside"), as.factor("inside"))

# Make same depth as TVC layer
dogFence <- rep(dogFence, length(names(TVC)))

rm(list = c("dogFence_shp", "dogFence_Index", "dogFence_Extent", "extent"))

```

# Convert raster variables to dataframe

```{r}
# Names of variables to include
varNames <- c("waterRaster", 
              "TVC", "PV", "NPV", "meanPV", "stdPV", "maxPV",
              "rainfallGPM36", "rainfallGPM24", "rainfallGPMa", "rainfallGPMq", "rainfallGPMm",
              "rainfallCHIRPS24", "rainfallCHIRPSa", "rainfallCHIRPSq", "rainfallCHIRPSm", 
              "rainfallAGCD24", "rainfallAGCDa", "rainfallAGCDq", "rainfallAGCDm", 
              "dogFence",
              "stationsRaster",
              "regionsRaster",
              "subregionsRaster",
              "landSystemsRaster",
              "nvis")

vars <- lapply(varNames, get)

months <- lapply(c(1:length(names(vars[[1]]))) , \(nMonths) rast(sapply(vars, "[[", nMonths)))

# Create dataframes of rasters for each year
monthDFs <- lapply(months, function(x) as.data.frame(x, xy = T, cells = T))

for (i in 1:length(monthDFs)) {
  monthDFs[[i]] <- monthDFs[[i]] %>% 
    add_column(Year = as.numeric(year(time(TVC[[i]][[1]]))), .after = 3) %>% 
    add_column(Month = as.numeric(month(time(TVC[[i]][[1]]))), .after = 4)
}

# 106655035
# sum(unlist(lapply(monthDFs, nrow)))

for (i in 1:length(monthDFs)) {
  names(monthDFs[[i]]) <- c("cell", "x", "y", "year", "month", varNames)
}


DFall <- data.table::rbindlist(monthDFs)

# Convert -999 back to NA (NAs don't work with as.data.frame properly).
DFall[DFall == -999] <- NA

# Simplify names
names(DFall) <- c("cell", "x", "y", "year", "month", "water", "tvc", "pv", "npv", "pvmean", "pvstd", "pvmax", "p_img_36", "p_img_24", "p_img_12", "p_img_3", "p_img_1", "p_ch_24", "p_ch_12", "p_ch_3", "p_ch_1", "p_agcd_24", "p_agcd_12", "p_agcd_3", "p_agcd_1", "d_fence", "sttn", "ibra_r", "ibra_sr", "l_sys", "nvis")
```

# Add stocking data
```{r}
destockYear <- list(as_date("2009/01/01"),
                    as_date("2023/01/01"))
names(destockYear) <-  c("Bon Bon", "Coondambo")


DFall <- DFall %>% 
  add_column(tsd = as.numeric(NA)) %>%
  mutate(date = ym(paste(year, "/", month)))

for (s in 1:length(destockYear)) {
  index <- which(DFall$sttn == names(destockYear)[s] & DFall$year < year(destockYear[[s]]))
  DFall$tsd[index] <- 0
  
  afterIndex <- which(DFall$sttn == names(destockYear)[s] & DFall$year >= year((destockYear[[s]])))
  
  if (length(afterIndex) > 0) {
    date_diff <- unlist(lapply(DFall$date[afterIndex], function(x) {x - destockYear[[s]]}))
    DFall$tsd[afterIndex] <- date_diff/365
  }
}
```

# Add EN34

```{r eval = FALSE}
en34 <- read_csv("E:/Data/EN34/en34_timeseries.csv")
tmp <- en34[which(en34$date %in% DFall$date), ]

DFall <- DFall %>% 
  add_column(en34 = as.numeric(NA),
             en34_c = as.numeric(NA),
             en34_anom_12mo = as.numeric(NA))

dates <- unique(DFall$date)

for (i in 1:length(unique(DFall$date))) {
  DFall[which(DFall$date == dates[i]), 34:36] <- en34[which(en34$date == dates[i]), 2:4]
}
```

# Save DF

```{r, eval = FALSE}
write_rds(DFall, file.path(outputFolder, "RasterDF.rds"))
```

