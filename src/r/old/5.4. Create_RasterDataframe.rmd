---
title: "Create_Dataframe"
author: "Angus Retallack"
date: "2023-03-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, lubridate, terra, sf, fields, arrow, data.table)

outputFolder <- "./RasterVariables"
```

# Load FC variables
```{r}
path_fc <- "E:/Data/MODIS/GuerschmanFC/Monthly/Processed"

# Create blank raster - used to project all datasets to same coordinate system
blankRast <- file.path(path_fc, "TVC") %>% 
  list.files("*.tif$", full.names = T) %>% 
  .[1] %>% 
  rast()
blankRast[!is.na(blankRast)] <- NA
names(blankRast) <- "blankRast"

# Polygon extent of study area
extent <- read_sf("./Vector/StudyArea.shp")

# Get Dates from TVC file names
dates <- list.files(file.path(path_fc, "TVC"), "*.tif$") %>% 
  substr(., 18, 24) %>% 
  str_replace("\\.", "-") %>% 
  paste0(., "-01") %>% 
  as_date()

# Get first and last dates - used to make sure temporal extent of all datasets 
# are the same
firstDate <- dates[1]
lastDate <- dates[length(dates)]

process_fc <- function(product) {
if (product == "TVC") {
  rast <- file.path(path_fc, product) %>% 
  list.files("*.tif$", full.names = TRUE) %>% 
  rast() %>% 
  as.data.frame(xy = T, cells  = T)
  names(rast)[4:ncol(rast)] <- as.character(dates)
  rast <- rast %>% 
  pivot_longer(cols = 4:ncol(.), names_to = "date", values_to = product)
} else {
  if (product == "PV") {
    band <- "_2"
  } 
  
  if (product == "NPV") {
    band <- "_3"
  } 
  
  if (product == "Bare") {
    band <- "_1"
  }
  
  rast <- list.files(path_fc, "*.tif$", full.names = TRUE) %>% 
  .[which(str_detect(., band))] %>% 
  rast() %>% 
  as.data.frame(xy = T, cells  = T)
  names(rast)[4:ncol(rast)] <- as.character(dates)
  rast <- rast %>% 
  pivot_longer(cols = 4:ncol(.), names_to = "date", values_to = product)
}
  
return(rast)
}

tvc <- process_fc("TVC")
setDT(tvc)
pv <- process_fc("PV")
setDT(pv)
npv <- process_fc("NPV")
setDT(npv)
bare <- process_fc("Bare")
setDT(bare)
```


# Statistical zones

Vector datasets including station boundaries, etc. used for grouping in modelling
Converted to raster data

```{r}
stations <- read_sf("./Vector/stations.shp") %>% 
  vect() %>% 
  rasterize(blankRast, field = "name") %>% 
  as.data.frame(xy = T, cells = T)
names(stations)[4] <- "station"
setDT(stations)

paddocks <- read_sf("./Vector/paddocks.shp") %>%
  st_transform(crs = "EPSG:28353") %>% 
  vect() %>% 
  rasterize(blankRast, field = "NAME") %>% 
  as.data.frame(xy = T, cells = T)

ibra_r <- read_sf("./Vector/IBRA.shp") %>% 
  vect() %>% 
  rasterize(blankRast, field = "reg_name_7") %>% 
  as.data.frame(xy = T, cells = T)
setDT(ibra_r)

ibra_sr <- read_sf("./Vector/IBRA.shp") %>% 
  vect() %>% 
  rasterize(blankRast, field = "sub_name_7") %>% 
  as.data.frame(xy = T, cells = T)
setDT(ibra_sr)

# Land systems
l_sys <- read_sf("E:/Data/Basedata/Mapland/Statewide/LANDSCAPE_LandSystemsMapping_GDA2020.shp") %>% 
  st_transform("EPSG:28353") %>% 
  vect() %>% 
  rasterize(blankRast, field = "LANDSYSTEM") %>% 
  as.data.frame(xy = T, cells = T)
setDT(l_sys)

# NVIS categories

nvis_s <- rast("E:/Data/NVIS/FGDB_NVIS6_0_AUST_EXT_MVS/NVIS6_0_AUST_EXT_MVS_ALB.tif") %>% 
  project(blankRast)
nvis_s[nvis_s == "Unknown/No data"] <- -999
nvis_s <- nvis_s %>% 
  as.data.frame(xy = T, cells = T)
setDT(nvis_s)

nvis <- rast("E:/Data/NVIS/FGDB_NVIS6_0_AUST_EXT_MVG/NVIS6_0_AUST_EXT_MVG_ALB.tif") %>% 
  project(blankRast)
nvis[nvis == "Unknown/no data"] <- -999
nvis <- nvis %>% 
  as.data.frame(xy = T, cells = T)
setDT(nvis)

# Nearby Bon Bon
## Areas that are within a 10 km buffer of Bon Bon for finer-scale modelling
bonbon <- read_sf("./Vector/stations.shp") %>% 
  as_tibble() %>% 
  .[which(.$name == "Bon Bon"), ] %>% 
  st_as_sf() %>% 
  st_geometry()

zone <- bonbon %>% 
  st_buffer(10000) %>% 
  st_intersection(c(., bonbon)) %>% 
  as_tibble() %>% 
  add_column(zone = c(2, 1)) %>% 
  st_as_sf() %>% 
  vect() %>% 
  rasterize(blankRast, field = "zone")

zone[is.na(zone)] <- 3

zone <- zone %>% 
  as.data.frame(xy = T, cells = T)

setDT(zone)

# station fence buffer
fences <- read_sf("E:/Data/Basedata/Mapland/Statewide/ADMIN_PastoralStations_GDA2020_GDASALamb.shp") %>%
  st_cast("POLYGON") %>%
  st_cast("LINESTRING") %>%
  st_buffer(500) %>%
  st_union() %>%
  as_tibble() %>%
  add_column(fence = 1) %>%
  st_as_sf() %>%
  st_transform(28353) %>% 
  vect() %>%
  rasterize(blankRast, field = "fence") %>% 
  as.data.frame(xy = T, cells = T)
setDT(fences)


# Dog Fence
dog_fence_shp <- read_sf("E:/Data/DogFence/dogFence_Polygons.shp") %>% 
  st_cast("POLYGON") %>% 
  st_transform("EPSG:28353") %>% 
  as_tibble() %>% 
  .[, -1] %>% 
  mutate(shape_area = as.numeric(st_area(st_make_valid(geometry))), .before = 1) %>% 
  arrange(desc(shape_area)) %>% 
  add_column(inside = 1, .before = 1)

# Set largest polygon to 0
dog_fence_shp$inside[1] <- 0

extent <- read_sf("./Vector/stations.shp") %>%
  vect() %>% 
  rasterize(blankRast, field = "name")
extent[!is.na(extent)] <- 1
extent <- extent %>%
  as.polygons() %>%
  st_as_sf() %>% 
  st_geometry() %>% 
  st_cast("POLYGON")

dog_fence <- st_intersection(dog_fence_shp$geometry, extent) %>% 
  st_cast("MULTIPOLYGON") %>% 
  st_cast("POLYGON") %>% 
  as_tibble() %>% 
  add_column(inside = as.numeric(NA), .before = 1)


for (i in 1:nrow(dog_fence)) {
  dogFence_Index <- as.numeric(na.omit(as.numeric(st_intersects(st_point_on_surface(dog_fence$geometry[i]), dog_fence_shp$geometry))))
  dog_fence$inside[i] <- dog_fence_shp$inside[dogFence_Index]
}

dog_fence <- dog_fence %>% 
  st_as_sf()

dog_fence <- dog_fence %>% 
  vect() %>% 
  rasterize(blankRast, field = "inside") %>% 
  as.data.frame(xy = T, cells = T)

rm(list = c("dog_fence_shp", "dogFence_Index"))
```

# Time since destock

```{r}
destockYear <- list(as_date("2009/01/01"),
                    as_date("2023/01/01"))
names(destockYear) <-  c("Bon Bon", "Coondambo")

tsd <- tibble(station = rep(names(destockYear), each = length(dates)),
              date = rep(dates, length(names(destockYear)))) %>%
  mutate(year = year(date),
         month = month(date)) %>% 
  add_column(tsd = as.numeric(NA))


for (s in 1:length(destockYear)) {
  index <- which(tsd$station == names(destockYear)[s] & tsd$year < year(destockYear[[s]]))
  tsd$tsd[index] <- 0
  
  afterIndex <- which(tsd$station == names(destockYear)[s] & tsd$year >= year((destockYear[[s]])))
  
  if (length(afterIndex) > 0) {
    date_diff <- unlist(lapply(tsd$date[afterIndex], function(x) {x - destockYear[[s]]}))
    tsd$tsd[afterIndex] <- date_diff/365
  }
}

tsd <- tsd %>% 
  mutate(stocked = ifelse(tsd > 0, 0, 1))
tsd$date <- as.character(tsd$date)
```

# BHP stocking data

```{r}
stocking <- read_csv("E:/Data/BHP/stock_returns/returns_processed.csv")
```


# Water areas

```{r}
water <- read_sf("E:/Data/Water Courses/HydroPolys_clip.shp") %>% 
  add_column(water = 1) %>% 
  st_transform("EPSG:28353") %>% 
  vect() %>% 
  rasterize(blankRast, field = "water")

water[water != 1] <- NA

water <- water %>% 
  as.data.frame(xy = T, cells = T)
setDT(water)
```

# Rainfall

```{r}
# Function to process rainfall datasets
processRainfall <- function(path, dataset_name) {
  precip <- list.files(path, "*.tif$", full.names = TRUE) %>%
  rast() %>% 
  project(blankRast) %>%
  as.data.frame(xy = T, cells = T)

names(precip)[4:ncol(precip)] <- list.files(path, "*.tif$") %>% 
  str_split("\\.", simplify = T) %>% 
  .[, 5] %>% 
  str_split("-", simplify  = T) %>% 
  .[, 1] %>% 
  as_date("%Y%m%d", tz = NULL) %>% 
  as.character()

precip <- precip %>%  
  pivot_longer(., cols = 4:ncol(.), names_to = "date", values_to = dataset_name)
setDT(precip)

return(precip)
}

p_img_36 <- processRainfall("E:/Data/Rainfall/GPM IMERG/Processed/RollingTriAnnual", "p_img_36")
p_img_24 <- processRainfall("E:/Data/Rainfall/GPM IMERG/Processed/RollingBiAnnual", "p_img_24")
p_img_12 <- processRainfall("E:/Data/Rainfall/GPM IMERG/Processed/RollingAnnual", "p_img_12")
p_img_3 <- processRainfall("E:/Data/Rainfall/GPM IMERG/Processed/RollingQuarterly", "p_img_3")
```

# AGCD Climate Data

```{r eval}
process_agcd <- function(path, dataset_name) {
  rast <- list.files(path, "*.tif$", full.names = T) %>% 
  rast() %>% 
  project(blankRast) %>% 
  crop(extent) %>% 
  as.data.frame(xy = T, cells = T)

  names(rast)[4:ncol(rast)] <- list.files(path, "*.tif$") %>% 
    str_split("_", simplify = T) %>% 
    .[, 1] %>% 
    str_split("-", simplify = T) %>% 
    .[, 1:2] %>% 
    apply(., 1, function(x) str_flatten(x, "-")) %>% 
    paste0(., "-01") %>% 
    as_date() %>% 
    as.character()

  rast <- rast %>% 
    pivot_longer(., cols = 4:ncol(.), names_to = "date", values_to = dataset_name)
  
  return(rast)
}

tmax <- process_agcd("E:/Data/retallack_agcd/tmax/", "tmax")
setDT(tmax)

tmax_3 <- process_agcd("E:/Data/retallack_agcd/tmax_3/", "tmax_3")
setDT(tmax_3)

tmin <- process_agcd("E:/Data/retallack_agcd/tmin/", "tmin")
setDT(tmin)

tmin_3 <- process_agcd("E:/Data/retallack_agcd/tmin_3/", "tmin_3")
setDT(tmin_3)

tmean <- process_agcd("E:/Data/retallack_agcd/tmean/", "tmean")
setDT(tmean)

tmean_3 <- process_agcd("E:/Data/retallack_agcd/tmean_3/", "tmean_3")
setDT(tmean_3)

vpd <- process_agcd("E:/Data/retallack_agcd/vpd/", "vpd")
setDT(vpd)

vpd_3 <- process_agcd("E:/Data/retallack_agcd/vpd_3/", "vpd_3")
setDT(vpd_3)

```

# EN34

```{r}
en34 <- read_csv("E:/Data/EN34/en34_timeseries.csv")
en34 <- en34[which(en34$date %in% dates), ]
en34$date <- as.character(en34$date)
setDT(en34)

```


# cbind / merge data tables

datasets where time series match perfectly with tvc use cbind.
Otherwise use merge to merge by other fields for proper matching

```{r}
DF <- cbind(tvc, pv[,5]) %>% 
  cbind(., npv[,5]) %>%
  cbind(., bare[,5]) %>%
  merge(., stations, by = c("cell", "x", "y"), all.x = T) %>%
  merge(., paddocks, by = c("cell", "x", "y"), all.x = T) %>%
  merge(., ibra_r, by = c("cell", "x", "y"), all.x = T) %>%
  merge(., ibra_sr, by = c("cell", "x", "y"), all.x = T) %>%
  merge(., l_sys, by = c("cell", "x", "y"), all.x = T) %>%
  merge(., nvis_s, by = c("cell", "x", "y"), all.x = T) %>%
  merge(., nvis, by = c("cell", "x", "y"), all.x = T) %>%
  merge(., zone, by = c("cell", "x", "y"), all.x = T) %>%
  merge(., fences, by = c("cell", "x", "y"), all.x = T) %>%
  merge(., dog_fence, by = c("cell", "x", "y"), all.x = T) %>%
  merge(., tsd[, c("station", "date", "tsd", "stocked")], by = c("station", "date"), all.x = T) %>%
  merge(., water, by = c("cell", "x", "y"), all.x = T) %>%
  merge(., p_img_36, by = c("cell", "x", "y", "date"), all.x = T) %>%
  merge(., p_img_24, by = c("cell", "x", "y", "date"), all.x = T) %>%
  merge(., p_img_12, by = c("cell", "x", "y", "date"), all.x = T) %>%
  merge(., p_img_3, by = c("cell", "x", "y", "date"), all.x = T) %>%
  merge(., tmax, by = c("cell", "x", "y", "date"), all.x = T) %>%
  merge(., tmax_3, by = c("cell", "x", "y", "date"), all.x = T) %>%
  merge(., tmin, by = c("cell", "x", "y", "date"), all.x = T) %>%
  merge(., tmin_3, by = c("cell", "x", "y", "date"), all.x = T) %>%
  merge(., tmean, by = c("cell", "x", "y", "date"), all.x = T) %>%
  merge(., tmean_3, by = c("cell", "x", "y", "date"), all.x = T) %>%
  merge(., vpd, by = c("cell", "x", "y", "date"), all.x = T) %>%
  merge(., vpd_3, by = c("cell", "x", "y", "date"), all.x = T) %>%
  merge(., en34, by = "date", all.x = T)

station_areas <- read_sf("E:/Data/Basedata/Mapland/Statewide/ADMIN_PastoralStations_GDA2020.shp") %>% 
  filter(NAME %in% unique(DF$station)) %>% 
  st_cast("MULTIPOLYGON") %>% 
  st_cast("POLYGON") %>% 
  st_transform(crs = "EPSG:28353") %>% 
  mutate(area = as.numeric(st_area(geometry))) %>% 
  .[, c("NAME", "area")] %>% 
  st_drop_geometry() %>% 
  rename("station" = "NAME") %>% 
  group_by(station) %>% 
  summarise(area = sum(area))

DF <- DF %>%
  merge(., station_areas, by = c("station"), all.x = T)
rm(station_areas)


DF <- DF %>%
  mutate(year = year(date), .after = 1) %>% # add year column to DF to merge stocking data by
  merge(stocking[, c("station", "year", "opening_cattle", "cattle_area", "cattle_area_2", "cattle_area_3", "opening_sheep", "sheep_area", "sheep_area_2", "sheep_area_3", "stock_area", "stock_area_2", "stock_area_3")], by = c("station", "year"), ., all.y = T) %>%
  filter(year > 2000) # remove years before 2000 that are introduced by stocking data


names(DF) <- c("station", "year", "opening_cattle", "cattle_area", "cattle_area_2", "cattle_area_3", "opening_sheep", "sheep_area", "sheep_area_2", "sheep_area_3", "stock_area", "stock_area_2", "stock_area_3", "date", "cell", "x", "y", "tvc", "pv", "npv", "bare", "paddock", "ibra_region", "ibra_subregion", "l_sys", "nvis_subgroup", "nvis_group", "study_zone", "fence_buffer", "dog_fence", "tsd", "stocked", "water", "p_img_36", "p_img_24", "p_img_12", "p_img_3", "tmax", "tmax_3", "tmin", "tmin_3", "tmean", "tmean_3", "vpd", "vpd_3", "en34", "en34_c", "en34_anom_12mo", "station_area")

```

# Save DF

```{r, eval = FALSE}
write_rds(DF, file.path(outputFolder, "RasterDF.rds"))
```
