---
title: "Spatial GAMs"
author: "Angus Retallack"
date: "2022-10-23"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, sf, gstat, mgcv, mgcViz, gratia, data.table, lubridate)
```

# Import data

```{r}
# write_parquet(DF, "./RasterVariables/RasterDF.parquet")
# DF <- arrow::open_dataset("./RasterVariables/RasterDF.parquet")
DF1 <- read_rds("./RasterVariables/RasterDF.rds") %>% 
  filter(!is.na(p_img_3)) %>% 
  filter(!is.na(p_img_12)) %>%
  filter(!is.na(p_img_24)) %>%
  filter(!is.na(p_img_36)) %>% 
  filter(is.na(water)) %>% 
  filter(!station %in% c("Lake Torrens NP", "Other", "Kati Thanda-Lake Eyre NP", "Lake Gairdner NP", "Salt Lake", "Lake Everard", "Coward Springs Railway Siding", "Coober Pedy Commonage", "Wadma Kadarbu Mound Springs CP")) %>%  
  as.data.table()

DF <- DF[,`:=`(pv.tvc = pv/tvc)]

DF <- DF[order(cell, date)] %>% 
  mutate(pv_3 = frollmean(pv, 3),
         pv_12 = frollmean(pv, 12))

DF$sttn <- droplevels(DF$sttn)



```

# Create models

**bam**

Fits a generalized additive model (GAM) to a very large data set, the term 'GAM' being taken to include any quadratically penalized GLM (the extended families listed in family.mgcv can also be used). The degree of smoothness of model terms is estimated as part of fitting. In use the function is much like gam, except that the numerical methods are designed for datasets containing upwards of several tens of thousands of data (see Wood, Goude and Shaw, 2015). The advantage of bam is much lower memory footprint than gam, but it can also be much faster, for large datasets. bam can also compute on a cluster set up by the parallel package.

An alternative fitting approach (Wood et al. 2017, Li and Wood, 2019) is provided by the discrete==TRUE method. In this case a method based on discretization of covariate values and C code level parallelization (controlled by the nthreads argument instead of the cluster argument) is used. This extends both the data set and model size that are practical.

https://www.rdocumentation.org/packages/mgcv/versions/1.8-40/topics/bam

# Model testing

## Spatial autocorrelation

```{r}
# Temporary random sample for testing
tmp <- DF[sample(.N, 1000)]

```


```{r}
# DFtrain <- DF[sample(.N, 10000)]
tmp <- DF[sample(.N,1000)]


ac0 <- pgirmess::correlog(tmp[, c("x", "y")], tmp$pv)
plot(ac0)
```


## Rainfall only 

```{r}
mod1 <- bam(pv ~ s(p_img_12, k = 5), 
            family = gaussian(),
            select = TRUE,
            method = "fREML",
            discrete = T,
            data = tmp)


ac1 <- pgirmess::correlog(coords = tmp[, c("x","y")], 
                          z = tmp %>% 
                            mutate(res = pv - predict(mod1, newdata = .)) %>% 
                            pull("res"))

plot(ac1)
```
# Rainfall + XY

```{r}
mod2 <- bam(pv ~
            s(p_img_12, k=5) +
            te(x, y, fx = T),
            family = gaussian(),
            select = TRUE,
            # gamma=5,
            method = "fREML",
            discrete = T,
            data = tmp)

summary(mod2)

ac2 <- pgirmess::correlog(tmp[, c("x","y")], 
                          z = tmp %>% 
                            mutate(res = pv - predict(mod2, newdata = .)) %>% 
                            pull("res"))

plot(ac2)

plot(mod2, select=1)
```

# Time correlation
```{r eval = FALSE}
library(nlme)
library(lubridate)
tmp3 <- DFtrain[,`:=`(ddate = decimal_date(ymd(paste(year,month,1))))]
tmp3 <- tmp3[,`:=`(id_xy = .GRP), by=.(x,y)][order(id_xy,ddate)]

# tmp3[1:10000,] %>% select(id_xy, ddate) %>% pull(ddate) %>% plot

# new column 'ddate'
DF[,`:=`(ddate = decimal_date(ymd(paste(year,month,1))))]
# sample 30 random xy locations
vec_ids <- sample(unique(DF$cell), 30)
# subset containing xy coords selected above, ordered by cell and date
tmp3 <- DF[cell %in% vec_ids][order(cell,ddate)]
tmp3

lme(pv ~ 1, 
    correlation = corAR1(form = ~ ddate|cell), 
    data=tmp3)

```

# Model including year and month

```{r}
# # Intercept only model 
# m3 <- lme(pv ~ 1,
#     random = ~ 1|cell,
#     correlation = corAR1(), 
#     data = DF[sample(.N, 30)] %>% 
#       mutate(cell = as.factor(cell))
#     )
# summary(m3)


# Get 30 random cell numbers for each station
vec_ids <- which(DF$sttn %in% unique(DF$sttn)[1]) %>% sample(5)

for (i in 2:length(unique(DF$sttn))) {
  vec_ids <- c(vec_ids, which(DF$sttn %in% unique(DF$sttn)[i]) %>% sample(5))
}

cell_ids <- DF[vec_ids]$cell

m4 <- bam(pv ~
      # continuous var, grouping factor, bs='factor smooth'
      s(ddate, sttn, bs='fs', k = 20) +  # effect of date grouped by cell location
      s(month, bs='cc', k = 5) + # Effect of month, cyclical smooth, start = end
      te(x, y, fx = T, k = 20),
    family = gaussian(),
    select = TRUE,
    # rho = 0.79,
    # AR.start = (tmp3$ddate == (tmp3$ddate %>% min)),
    method = "fREML",
    discrete = T,
    data = DF[cell %in% vec_ids] %>%
      mutate(fcell = as.factor(cell),
             ddate = decimal_date(ymd(paste(year,month,1)))) %>%
      .[order(cell, ddate)]
    )
summary(m4)
plot(m4, pages = 1, scheme = 2)


m5 <- bam(pv ~
            # continuous var, grouping factor, bs='factor smooth'
            s(ddate, k = 10) +  # effect of date grouped by cell location
            s(ddate, by = sttn, bs = "fs", k = 10) +  # effect of date grouped by cell location
            s(month, bs='cc', k = 5) + # Effect of month, cyclical smooth, start = end
            s(p_img_24, k = 5) +
            s(p_img_3, k = 5) +
            te(x, y, fx = T, k = 20),
          family = gaussian(),
          select = TRUE,
          # rho = 0.79, # taken from m3 to deal with temporal autocorrelation
          # AR.start = (tmp3$ddate == (tmp3$ddate %>% min)),
          method = "fREML",
          discrete = T,
          data = DF[cell %in% vec_ids] %>%
            mutate(fcell = as.factor(cell),
                   ddate = decimal_date(ymd(paste(year,month,1)))) %>%
            .[order(cell, ddate)]
      )

summary(m5)
plot(m5, pages = 1, scheme = 2)


# # Grouping rainfall by station. 
# m6 <- bam(pv ~ 
#             # continuous var, grouping factor, bs='factor smooth'
#             s(ddate, fcell, bs='fs') + 
#             s(month, bs='cc') +
#             s(p_img_12, sttn, bs = "fs", k=5) + 
#             te(x, y, fx = T),
#           family = gaussian(),
#           select = TRUE,
#           # rho = 0.79, # taken from m3 to deal with temporal autocorrelation
#           # AR.start = (tmp3$ddate == (tmp3$ddate %>% min)),
#           method = "fREML",
#           discrete = T,
#           data = DF[cell %in% vec_ids] %>% 
#             mutate(fcell = as.factor(cell),
#                    ddate = decimal_date(ymd(paste(year,month,1)))) %>% 
#             .[order(cell, ddate)]
# )
# summary(m6)
# plot(m6, pages = 1)



m7 <- bam(pv_3 ~ # (pv+npv) (pv/npv)
            # continuous var, grouping factor, bs='factor smooth'
            # s(tsd, k = 5) + 
            s(en34)+
            s(ddate, k = 20, m = 2) + # across station temporal effect (la nina, etc)
            s(ddate, sttn, bs='fs', k = 20, m = 1) + # differences in management
            s(month, bs='cc') + # phenology (maybe group by sttn or nvis)
            s(p_img_36, nvis, bs = 'fs', k = 5) + # 3 year precip variability (g by nvis)
            # s(p_img_24, l_sys, bs = "fs", k = 5) + # IAV (g by nvis)
            s(p_img_12, nvis, bs = 'fs', k = 5) + # annual precip variability (g by nvis)
            s(p_img_3, nvis, bs = 'fs', k = 5) + # seasonal p variability (g by nvis)
            te(x, y, fx = T, k = 20), # spatial (maybe set k higher)
          family = gaussian(),
          select = TRUE,
          # rho = 0.79, # taken from m3 to deal with temporal autocorrelation
          # AR.start = (tmp3$ddate == (tmp3$ddate %>% min)),
          method = "fREML",
          discrete = T,
          data = DF[cell %in% cell_ids, ] %>% 
            mutate(fcell = as.factor(cell),
                   ddate = decimal_date(ymd(paste(year,month,1)))) %>% 
            .[order(cell, ddate)]
)

summary(m7)
plot(m7, pages = 2, scheme = 2, scale = 0, rug = T)

jnk <- gratia::smooth_estimates(m7)
jnk <- jnk %>% as.data.table()

jnk[smooth == "s(ddate,sttn)"] %>% 
  ggplot(data = .,aes(ddate, est, color = sttn)) +
  geom_line() +
  geom_line(data = jnk[smooth == "s(ddate)"], 
            aes(ddate, est), color = c("#000000"),lwd = 2) +
# geom_smooth(inherit.aes = F, 
#               aes(ddate, est),
#               method='gam',
#               formula = y~s(x,k=20),
#               color='black',
#               lwd=2)+
  geom_line(data = jnk[smooth == "s(ddate,sttn)"][sttn == "Bon Bon"], 
            aes(ddate, est), color = c("#cf0000"),lwd = 2)

# DF with only stations that have stocking data.
tmp <- DF[(is.na(DF$tsd)) == F] %>% 
  droplevels()

# Get 30 random cell numbers for each station
tmp_ids <- which(tmp$sttn %in% unique(tmp$sttn)[1]) %>% sample(30)

for (i in 2:length(unique(tmp$sttn))) {
  tmp_ids <- c(tmp_ids, which(tmp$sttn %in% unique(tmp$sttn)[i]) %>% sample(30))
}

tmp_cell_ids <- tmp[tmp_ids]$cell

m8 <- bam(pv ~ # (pv+npv) (pv/npv)
            # continuous var, grouping factor, bs='factor smooth'
            s(tsd, sttn, bs = 'fs', k = 5) +
            s(ddate, k = 20, m =2) + # across station temporal effect (la nina, etc)
            s(en34, k = 5) + # across station temporal effect (la nina, etc)
            s(ddate, sttn, bs='fs', k = 20, m = 1) + # differences in management
            # s(month, bs='cc') + # phenology (maybe group by sttn or nvis)
            s(p_img_36, nvis, bs = 'fs', k = 5) + # 3 year precip variability (g by nvis)
            # s(p_img_24, nvis, bs = "fs", k = 5) + # IAV (g by nvis)
            s(p_img_12, nvis, bs = 'fs', k = 5) + # annual precip variability (g by nvis)
            s(p_img_3, nvis, bs = 'fs', k = 5) + # seasonal p variability (g by nvis)
            te(x, y, fx = T, k = 20), # spatial (maybe set k higher)
          family = gaussian(),
          select = TRUE,
          method = "fREML",
          discrete = T,
          data = tmp[cell %in% tmp_cell_ids, ] %>% 
            mutate(fcell = as.factor(cell),
                   ddate = decimal_date(ymd(paste(year,month,1)))) %>% 
            .[order(cell, ddate)]
)
# summary(m8)
plot(m8, pages = 2, scheme = 2)

```

# individual models for each station
```{r}
station_name <- as.vector(unique(DF$sttn))[3]

f_fit_mods <- function(station_name, nsamps){
  
  cells <- sample(unique(DF[sttn == station_name]$cell), nsamps)
  
  tmp <- DF[cell %in% cells] %>% 
              mutate(fcell = as.factor(cell),
                     ddate = decimal_date(ymd(paste(year,month,1)))) %>%
              .[order(cell, ddate)]
  
  if (length(unique(tmp$l_sys)) > 1) {
    out <- bam(pv ~ 
                # continuous var, grouping factor, bs='factor smooth'
                s(ddate, fcell, bs = 'fs') + 
                s(month, bs = 'cc') +
                s(p_img_12, l_sys, k = 5, bs = 'fs') + 
                te(x, y, fx = T),
              family = gaussian(),
              select = TRUE,
              # rho = 0.79,
              # AR.start = (tmp3$ddate == (tmp3$ddate %>% min)),
              method = "fREML",
              discrete = T,
              data = tmp
              )
  } else { # If only one land system in station then dont group rainfall by l_sys
      out <- bam(pv ~ 
                # continuous var, grouping factor, bs='factor smooth'
                s(ddate, fcell, bs = 'fs') + 
                s(month, bs = 'cc') +
                s(p_img_12, k = 5) + 
                te(x, y, fx = T),
              family = gaussian(),
              select = TRUE,
              # rho = 0.79,
              # AR.start = (tmp3$ddate == (tmp3$ddate %>% min)),
              method = "fREML",
              discrete = T,
              data = tmp
              )
    }
 return(out)
}

l_mods <- lapply(as.vector(unique(DF$sttn)), f_fit_mods, nsamps = 30)
# Name list elements with stations
names(l_mods) <- as.vector(unique(DF$sttn))

# Extract plots for each station
for (i in 1:length(l_mods)) {
  png(file = file.path("U:/Documents/PhD/3. Chapter 3 - MODIS Analysis/StationPlots", paste0(names(l_mods)[[i]], ".png")),
      width = 2400,
      height = 1600,
      res = 300)
  
  plot(l_mods[[i]], pages = 1, main = names(l_mods)[[i]])

  dev.off()
}


m7 <- bam(pv ~ s(month, bs = "cc") + s(sttn, bs = "re") +
            s(sttn, year_f, bs = 're'),
          family = gaussian(),
          select = TRUE,
          data = DF[sample(.N, 1000)] %>% 
            mutate(year_f = as.factor(year)))

plot(m7, pages = 1)
```

```{r}
# Global smooth of ddate only
modG <- bam(pv ~ s(ddate, k = 5) +
              te(x, y, fx = T) +
              s(month, bs = 'cc') +
              s(p_img_12, l_sys, k = 5, bs = 'fs'),
            family = gaussian(),
            method = "fREML",
            data = DF[cell %in% vec_ids] %>% 
              mutate(fcell = as.factor(cell),
                     ddate = decimal_date(ymd(paste(year,month,1))))
            )

plot(modG, pages = 1)

# Global smooth of ddate plus group-level smooth

modGS <- bam(pv ~ s(ddate, k = 10, m = 2) +
               s(ddate, by = sttn, k = 10, bs = 'fs', m = 2) +
              te(x, y, k = 15, fx = T) +
              s(month, bs = 'cc') +
              s(p_img_12, l_sys, k = 5, bs = 'fs'),
            family = gaussian(),
            method = "fREML",
            data = DF[cell %in% vec_ids] %>% 
              mutate(fcell = as.factor(cell),
                     ddate = decimal_date(ymd(paste(year,month,1))))
            )
plot(modGS, pages = 1)
```

